import{s as je,r,j as e,B as h,H as ge,q as x,S as fe,ab as ve,h as v,E as Ne,D as ye,x as Se,y as be,z as Ce,A as we,K as Te,v as Ae,e as A,J as p}from"./index-Cm5HjFIo.js";import{C as Y,a as G}from"./card-C-b0mMpV.js";import{L as d}from"./label-BEIp1959.js";import{S as q,a as V,b as L,c as k,d as o}from"./select-BVacNl4j.js";import{T as De,a as Ee,b as Q,c as N,d as Ie,e as y}from"./table-CWxHh_dS.js";import{A as Pe,a as qe,T as Ve,b as Le,c as ke,d as Me,e as $e,f as ze,g as Be,h as Oe}from"./alert-dialog-CygBOIfR.js";import{P as _e,a as He,b as z,c as Re,d as Fe,e as Ue}from"./pagination-DDb5QyE8.js";import{e as Je}from"./exportData-RkqjTXsm.js";import{C as Ze}from"./CsvImportDialog-NzAewFzO.js";import{D as Ke}from"./download-DTd9ExxB.js";import{P as Ye}from"./plus-CMoeNdO_.js";import{P as Ge}from"./pencil-Bn-a4rRB.js";import"./index-CJUiwxDA.js";import"./file-text-BFQ76zi5.js";const ms=()=>{const B=je(),[W,O]=r.useState([]),[S,X]=r.useState(""),[D,ee]=r.useState("all"),[E,se]=r.useState("all"),[M,Qe]=r.useState("all"),[te,_]=r.useState(!1),[ae,H]=r.useState(!1),[u,re]=r.useState(null),[a,c]=r.useState({name:"",code:"",type:"temperature",unit:"",minValue:0,maxValue:100,criticalThreshold:80,equipmentId:"",status:"active"}),[j,R]=r.useState([]),[l,b]=r.useState(1),[I]=r.useState(15),[F,U]=r.useState(!0),[J,P]=r.useState(!1),ne=async()=>{var s;try{const n=((s=(await A.get("/equipment")).data)==null?void 0:s.data)||[];O(n.map(t=>{var m;return{id:t.id,name:t.name,code:t.code,type:t.type,zone:((m=t.zone)==null?void 0:m.name)||"N/A",fabricant:t.fabricant,status:t.status,criticite:t.criticite,sensors:t.sensors}}))}catch{O([])}},C=async()=>{var s;U(!0);try{const n=((s=(await A.get("/sensors")).data)==null?void 0:s.data)||[];R(n.map(t=>{var m,T,Z,K;return{id:t.id,equipmentId:t.equipment_id,name:t.name,code:t.code,type:t.type,unit:t.unite,criticalThreshold:t.seuil_critique,status:t.status,lastCalibration:t.Dernier_Etallonnage?new Date(t.Dernier_Etallonnage.replace(" ","T")).toLocaleString():"N/A",equipmentName:`${((m=t.equipment)==null?void 0:m.name)||"N/A"} - ${((Z=(T=t.equipment)==null?void 0:T.zone)==null?void 0:Z.name)||"N/A"}`,equipmentCode:(K=t.equipment)==null?void 0:K.code,isActive:t.status==="active"}}))}catch{R([])}U(!1)};r.useEffect(()=>{ne(),C()},[]);const g=j.filter(s=>{var T;const i=s.name.toLowerCase().includes(S.toLowerCase())||s.code.toLowerCase().includes(S.toLowerCase())||(((T=s.equipmentName)==null?void 0:T.toLowerCase())||"").includes(S.toLowerCase()),n=D==="all"||s.type===D,t=E==="all"||s.status===E,m=M==="all"||String(s.equipmentId)===M;return i&&n&&t&&m}),f=Math.ceil(g.length/I),ie=g.slice((l-1)*I,l*I);r.useEffect(()=>{b(1)},[S,D,E,M]),r.useEffect(()=>{const s=Math.ceil(g.length/I);s>0&&l>s&&b(s)},[g.length]);const le=async()=>{P(!0);try{await A.post(`/equipment/${a.equipmentId}/sensors`,{...a,criticalThreshold:String(a.criticalThreshold||"")}),p.success("Capteur créé"),C(),w()}catch{p.error("Erreur lors de l'ajout")}P(!1)},ce=async()=>{if(u){P(!0);try{await A.put(`/sensors/${u.id}`,{...a,criticalThreshold:String(a.criticalThreshold||"")}),p.success("Capteur modifié"),C(),w()}catch{p.error("Erreur lors de la modification")}P(!1)}},oe=async s=>{var i,n;try{await A.delete(`/sensors/${s}`),p.success("Capteur supprimé"),C()}catch(t){p.error(((n=(i=t.response)==null?void 0:i.data)==null?void 0:n.message)||"Erreur lors de la suppression")}},w=()=>{c({name:"",code:"",type:"temperature",unit:"",minValue:0,maxValue:100,criticalThreshold:80,equipmentId:"",status:"active"}),re(null),_(!1)},de=()=>{Je(g.map(s=>({Code:s.code,Nom:s.name,Type:s.type,Unité:s.unit||"N/A","Seuil critique":s.criticalThreshold||"N/A",Statut:s.status,Équipement:s.equipmentName||"N/A"})),`capteurs_${new Date().toISOString().split("T")[0]}`),p.success("Export réussi")},$=s=>({temperature:"Température",pressure:"Pression",vibration:"Vibration",flow:"Débit",level:"Niveau",speed:"Vitesse",position:"Position",other:"Autre"})[s]||s,ue=s=>{switch(s){case"active":return e.jsx(v,{className:"bg-primary text-primary-foreground text-xs font-bold",children:"SAIN"});case"bypassed":return e.jsx(v,{className:"bg-red-600 text-white text-xs font-bold",children:"EN BYPASS"});case"maintenance":return e.jsx(v,{variant:"outline",className:"text-xs font-bold",children:"EN MAINTENANCE"});case"inactive":case"faulty":return e.jsx(v,{className:"bg-orange-500 text-white text-xs font-bold",children:"EN DÉFAUT"});default:return e.jsx(v,{variant:"outline",className:"text-xs",children:s})}},me=j.filter(s=>s.status==="active").length,he=j.filter(s=>s.status==="bypassed").length,xe=j.filter(s=>["inactive","faulty","maintenance"].includes(s.status)).length,pe=[{label:"Total Capteurs",value:j.length,color:"bg-primary"},{label:"Sains / Actifs",value:me,color:"bg-primary"},{label:"En Bypass",value:he,color:"bg-orange-500"},{label:"En Défaut / Déconnectés",value:xe,color:"bg-red-500"}];return e.jsxs("div",{className:"w-full p-4 md:p-6 space-y-6 overflow-x-hidden",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-foreground",children:"Inventaire des Capteurs"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Registre complet et statut en temps réel des ",j.length," instruments de mesure du site."]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(h,{variant:"outline",size:"sm",onClick:de,children:[e.jsx(Ke,{className:"w-4 h-4 mr-2"}),"Exporter CSV"]}),e.jsxs(h,{size:"sm",onClick:()=>{w(),_(!0)},children:[e.jsx(Ye,{className:"w-4 h-4 mr-2"}),"Ajouter un Capteur"]})]})]}),e.jsx("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-4",children:pe.map(s=>e.jsx(Y,{className:"hover:shadow-md transition-shadow",children:e.jsxs(G,{className:"p-5 flex items-center gap-4",children:[e.jsx("div",{className:`w-10 h-10 rounded-lg ${s.color} opacity-80`}),e.jsxs("div",{children:[e.jsx("p",{className:"text-2xl font-bold",children:F?"...":s.value.toLocaleString()}),e.jsx("p",{className:"text-xs text-muted-foreground",children:s.label})]})]})},s.label))}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsxs("div",{className:"relative flex-1 min-w-[200px] max-w-md",children:[e.jsx(ge,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground"}),e.jsx(x,{placeholder:"Chercher par Tag, Zone, Modèle...",className:"pl-10 h-9",value:S,onChange:s=>X(s.target.value)})]}),e.jsxs(q,{value:D,onValueChange:ee,children:[e.jsx(V,{className:"w-[130px] h-9 text-sm",children:e.jsx(L,{placeholder:"Type: Tous"})}),e.jsxs(k,{children:[e.jsx(o,{value:"all",children:"Type: Tous"}),["temperature","pressure","vibration","flow","level","speed","position"].map(s=>e.jsx(o,{value:s,children:$(s)},s))]})]}),e.jsxs(q,{value:E,onValueChange:se,children:[e.jsx(V,{className:"w-[130px] h-9 text-sm",children:e.jsx(L,{placeholder:"Statut: Tous"})}),e.jsxs(k,{children:[e.jsx(o,{value:"all",children:"Statut: Tous"}),e.jsx(o,{value:"active",children:"Sain"}),e.jsx(o,{value:"bypassed",children:"En Bypass"}),e.jsx(o,{value:"maintenance",children:"Maintenance"}),e.jsx(o,{value:"inactive",children:"Inactif"})]})]})]}),e.jsx(Y,{children:e.jsx(G,{className:"p-0",children:F?e.jsx("div",{className:"p-6 space-y-3",children:[...Array(5)].map((s,i)=>e.jsx(fe,{className:"h-14 w-full"},i))}):g.length===0?e.jsxs("div",{className:"text-center py-12 text-muted-foreground",children:[e.jsx(ve,{className:"w-10 h-10 mx-auto mb-3 opacity-50"}),e.jsx("p",{children:"Aucun capteur trouvé"})]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(De,{children:[e.jsx(Ee,{children:e.jsxs(Q,{children:[e.jsx(N,{className:"text-xs font-semibold uppercase text-muted-foreground",children:"Identifiant & Description"}),e.jsx(N,{className:"text-xs font-semibold uppercase text-muted-foreground",children:"Type"}),e.jsx(N,{className:"text-xs font-semibold uppercase text-muted-foreground",children:"Zone"}),e.jsx(N,{className:"text-xs font-semibold uppercase text-muted-foreground",children:"Seuil"}),e.jsx(N,{className:"text-xs font-semibold uppercase text-muted-foreground",children:"Statut actuel"}),e.jsx(N,{className:"text-xs font-semibold uppercase text-muted-foreground text-right",children:"Actions"})]})}),e.jsx(Ie,{children:ie.map(s=>e.jsxs(Q,{className:"hover:bg-muted/50",children:[e.jsx(y,{children:e.jsxs("div",{children:[e.jsx("span",{className:"font-mono font-semibold text-primary text-sm",children:s.code}),e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5",children:s.name})]})}),e.jsx(y,{className:"text-sm",children:$(s.type)}),e.jsx(y,{className:"text-sm text-muted-foreground",children:s.equipmentName||"N/A"}),e.jsx(y,{children:s.criticalThreshold?e.jsxs(v,{variant:"outline",className:"text-xs",children:[s.criticalThreshold," ",s.unit]}):"-"}),e.jsx(y,{children:ue(s.status)}),e.jsx(y,{className:"text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-1",children:[e.jsx(h,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:()=>B(`/sensors/${s.id}`),children:e.jsx(Ne,{className:"w-3.5 h-3.5"})}),e.jsx(h,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:()=>B(`/sensors/${s.id}/edit`),children:e.jsx(Ge,{className:"w-3.5 h-3.5"})}),e.jsxs(Pe,{children:[e.jsx(qe,{asChild:!0,children:e.jsx(h,{variant:"ghost",size:"icon",className:"h-8 w-8 text-destructive hover:text-destructive",children:e.jsx(Ve,{className:"w-3.5 h-3.5"})})}),e.jsxs(Le,{children:[e.jsxs(ke,{children:[e.jsxs(Me,{children:["Supprimer ",s.code," ?"]}),e.jsx($e,{children:"Cette action est irréversible."})]}),e.jsxs(ze,{children:[e.jsx(Be,{children:"Annuler"}),e.jsx(Oe,{onClick:()=>oe(s.id),children:"Supprimer"})]})]})]})]})})]},s.id))})]})})})}),f>1&&e.jsx("div",{className:"flex justify-end",children:e.jsx(_e,{children:e.jsxs(He,{children:[e.jsx(z,{children:e.jsx(Re,{href:"#",onClick:s=>{s.preventDefault(),l>1&&b(l-1)},className:l===1?"pointer-events-none opacity-50":"cursor-pointer"})}),Array.from({length:Math.min(f,5)},(s,i)=>{const n=f<=5?i+1:Math.max(1,Math.min(l-2,f-4))+i;return e.jsx(z,{children:e.jsx(Fe,{href:"#",onClick:t=>{t.preventDefault(),b(n)},isActive:l===n,className:"cursor-pointer",children:n})},n)}),e.jsx(z,{children:e.jsx(Ue,{href:"#",onClick:s=>{s.preventDefault(),l<f&&b(l+1)},className:l===f?"pointer-events-none opacity-50":"cursor-pointer"})})]})})}),e.jsx(ye,{open:te,onOpenChange:s=>{s||w()},children:e.jsxs(Se,{className:"max-w-lg",children:[e.jsxs(be,{children:[e.jsx(Ce,{children:u?`Éditer ${u.code}`:"Ajouter un capteur"}),e.jsx(we,{children:u?"Modifier les informations du capteur":"Remplir les informations du nouveau capteur"})]}),e.jsxs("div",{className:"grid gap-4 py-2",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{children:"Nom *"}),e.jsx(x,{value:a.name,onChange:s=>c({...a,name:s.target.value}),placeholder:"Nom du capteur"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{children:"Code *"}),e.jsx(x,{value:a.code,onChange:s=>c({...a,code:s.target.value}),placeholder:"PT-3042"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{children:"Type"}),e.jsxs(q,{value:a.type,onValueChange:s=>c({...a,type:s}),children:[e.jsx(V,{children:e.jsx(L,{})}),e.jsx(k,{children:["temperature","pressure","vibration","flow","level","speed","position"].map(s=>e.jsx(o,{value:s,children:$(s)},s))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{children:"Unité"}),e.jsx(x,{value:a.unit,onChange:s=>c({...a,unit:s.target.value}),placeholder:"°C, bar, mm/s..."})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{children:"Min"}),e.jsx(x,{type:"number",value:a.minValue,onChange:s=>c({...a,minValue:Number(s.target.value)})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{children:"Max"}),e.jsx(x,{type:"number",value:a.maxValue,onChange:s=>c({...a,maxValue:Number(s.target.value)})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{children:"Seuil critique"}),e.jsx(x,{type:"number",value:a.criticalThreshold,onChange:s=>c({...a,criticalThreshold:Number(s.target.value)})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(d,{children:"Équipement *"}),e.jsxs(q,{value:a.equipmentId,onValueChange:s=>c({...a,equipmentId:s}),children:[e.jsx(V,{children:e.jsx(L,{placeholder:"Sélectionner un équipement"})}),e.jsx(k,{children:W.map(s=>e.jsxs(o,{value:String(s.id),children:[s.name," (",s.code,")"]},s.id))})]})]})]}),e.jsxs(Te,{className:"gap-2",children:[e.jsx(h,{variant:"outline",onClick:w,children:"Annuler"}),e.jsxs(h,{onClick:u?ce:le,disabled:J,children:[J&&e.jsx(Ae,{className:"w-4 h-4 mr-2 animate-spin"}),u?"Enregistrer":"Ajouter"]})]})]})}),e.jsx(Ze,{open:ae,onOpenChange:H,type:"sensors",onSuccess:()=>{C(),H(!1)}})]})};export{ms as default};
