import{x as xe,r as i,v as me,e as J,j as e,B as u,L as he,S as pe,z as G,U as je,h as c,D as fe,F as ve,G as ge,H as Ne,K as be,N as _e,J as m}from"./index-DddjZrTs.js";import{C as K,a as X,b as we,c as ye}from"./card-HJdulpyU.js";import{T as Ce}from"./textarea-BNHvbM7Z.js";import{L as Re}from"./label-BzSdYhZy.js";import{S as De,a as Se,b as Ae,c as Le,d as f}from"./select-DBKdREnk.js";import{P as ke,a as Te,b as S,c as Me,d as Pe,e as Ie}from"./pagination-BKLQRlEH.js";import{T as Ve,a as Ee,b as Z,c as h,d as qe,e as p}from"./table-DT_PqPTr.js";import{F as ze}from"./file-text-BLpMISKA.js";import{C as Fe}from"./circle-check-big-DYcsbzcm.js";import"./index-B6Fl2CXf.js";function We(){var F,$,B;const Q=xe(),[v,A]=i.useState([]),[W,Y]=i.useState({}),[a,g]=i.useState(null),[ee,N]=i.useState(!1),[l,b]=i.useState(1),[_,$e]=i.useState(10),[te,D]=i.useState(!0),[L,k]=i.useState(null),[se,ae]=i.useState("all"),[w,re]=i.useState("all"),{user:o}=me(),y=t=>t==="critical"||t==="emergency",T=()=>["chef_de_quart","responsable_hse","resp_exploitation","directeur","administrateur","supervisor","administrator","director"].includes((o==null?void 0:o.role)||""),ie=()=>["resp_exploitation","directeur","administrateur","administrator","director"].includes((o==null?void 0:o.role)||""),M=t=>y(t.priority)?t.validation_status_level1==="pending"&&T()?1:t.validation_status_level1==="approved"&&t.validation_status_level2==="pending"&&ie()?2:null:T()?1:null,P=(t,s)=>{Y(r=>({...r,[t]:s}))},I=t=>W[t]||"",ne={preventive_maintenance:"Maintenance préventive",corrective_maintenance:"Maintenance corrective",calibration:"Étalonnage",testing:"Tests",emergency_repair:"Réparation d'urgence",system_upgrade:"Mise à niveau système",investigation:"Investigation",other:"Autre"},V=t=>ne[t]??t,E=(t,s,r="",n)=>{try{const d=s.validation_status||"approved",j=r||s.rejection_reason||"";if(d==="rejected"&&j===""){m.error("Veuillez entrer un motif de rejet");return}if(n){const x=M(n);if(x===null){m.error("Vous n'êtes pas autorisé à valider cette demande");return}if(y(n.priority)&&x===2&&n.validation_status_level1!=="approved"){m.error("La validation niveau 1 doit être approuvée d'abord");return}}const H={...s};H.rejection_reason=d==="rejected"?j:null,J.put(`/requests/${t}/validate`,H).then(x=>{x.data&&(m.success(d==="approved"?"Demande approuvée":"Demande rejetée"),P(t,""),window.location.reload())}).catch(x=>{var O,U;m.error(((U=(O=x.response)==null?void 0:O.data)==null?void 0:U.message)||"Erreur lors de la validation")})}catch{m.error("Une erreur est survenue")}},q=t=>{switch(t==null?void 0:t.toLowerCase()){case"critical":return e.jsx(c,{className:"bg-red-600 text-white text-xs font-bold uppercase",children:"Critique"});case"high":return e.jsx(c,{className:"bg-orange-500 text-white text-xs font-bold uppercase",children:"Majeur"});case"medium":return e.jsx(c,{className:"bg-yellow-500 text-white text-xs font-bold uppercase",children:"Moyen"});case"low":case"normal":return e.jsx(c,{className:"bg-gray-400 text-white text-xs font-bold uppercase",children:"Mineur"});default:return e.jsx(c,{variant:"outline",className:"text-xs uppercase",children:t})}},le=t=>y(t.priority)?t.validation_status_level1==="pending"?"Ingénieur Sécurité":t.validation_status_level1==="approved"&&t.validation_status_level2==="pending"?"Directeur":"Complète":"Chef de quart";i.useEffect(()=>{if(!o){D(!1);return}D(!0),k(null),J.get("/requests/pending").then(t=>{var r;const s=((r=t.data)==null?void 0:r.data)||(Array.isArray(t.data)?t.data:[]);A(s)}).catch(t=>{var s,r;k(((r=(s=t.response)==null?void 0:s.data)==null?void 0:r.message)||"Erreur de chargement"),A([])}).finally(()=>D(!1))},[Q.key,o]);const C=v.filter(t=>{var r;return w==="all"||((r=t.priority)==null?void 0:r.toLowerCase())===w}),R=Math.ceil(C.length/_),z=(l-1)*_,oe=C.slice(z,z+_);i.useEffect(()=>{b(1)},[_,w]);const ce=v.filter(t=>{var s;return((s=t.priority)==null?void 0:s.toLowerCase())==="critical"}).length,de=[{title:"Demandes en attente",value:v.length,subtitle:`${v.length>0?"Nouvelles depuis 1h":"Aucune demande"}`},{title:"Risque Critique (SIL 3)",value:ce,subtitle:"Validation Ing. requise"},{title:"Délai dépassé (> 2h)",value:0,subtitle:"En attente d'action rapide"},{title:"Approuvés aujourd'hui",value:"-",subtitle:"Sur les demandes traitées"}],ue=t=>{const s=Date.now()-new Date(t).getTime(),r=Math.floor(s/6e4);if(r<60)return`Il y a ${r} min`;const n=Math.floor(r/60);return n<24?`Il y a ${n}h`:`Il y a ${Math.floor(n/24)}j`};return e.jsxs("div",{className:"w-full p-4 md:p-6 space-y-6 overflow-x-hidden",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-foreground",children:"Approbations"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aperçu et gestion des demandes d'inhibition de capteurs en attente."})]}),e.jsx(u,{asChild:!0,className:"w-full sm:w-auto",children:e.jsxs(he,{to:"/requests/new",className:"flex items-center justify-center gap-2",children:[e.jsx(ze,{className:"w-4 h-4"}),"Nouveau Bypass"]})})]}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4",children:de.map(t=>e.jsx(K,{className:"hover:shadow-md transition-shadow",children:e.jsx(X,{className:"p-5",children:e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:t.title}),e.jsx("p",{className:"text-3xl font-bold tracking-tight",children:t.value}),e.jsx("p",{className:"text-xs text-muted-foreground",children:t.subtitle})]})})},t.title))}),e.jsxs(K,{children:[e.jsx(we,{className:"pb-3",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs(ye,{className:"text-lg",children:["Liste des demandes (",C.length,")"]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx(u,{variant:se==="all"?"default":"outline",size:"sm",className:"h-8 text-xs",onClick:()=>ae("all"),children:"Statut: En attente"}),e.jsxs(De,{value:w,onValueChange:re,children:[e.jsx(Se,{className:"w-[140px] h-8 text-xs",children:e.jsx(Ae,{placeholder:"Risque: Tous"})}),e.jsxs(Le,{children:[e.jsx(f,{value:"all",children:"Risque: Tous"}),e.jsx(f,{value:"critical",children:"Critique"}),e.jsx(f,{value:"high",children:"Majeur"}),e.jsx(f,{value:"medium",children:"Moyen"}),e.jsx(f,{value:"low",children:"Mineur"})]})]})]})]})}),e.jsx(X,{children:te?e.jsx("div",{className:"space-y-3",children:[...Array(3)].map((t,s)=>e.jsx(pe,{className:"h-16 w-full"},s))}):L?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(G,{className:"w-10 h-10 text-destructive mx-auto mb-3"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-3",children:L}),e.jsx(u,{size:"sm",onClick:()=>window.location.reload(),children:"Réessayer"})]}):C.length===0?e.jsxs("div",{className:"text-center py-12 text-muted-foreground",children:[e.jsx(Fe,{className:"w-10 h-10 mx-auto mb-3 opacity-50"}),e.jsx("p",{children:"Aucune demande en attente"})]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(Ve,{children:[e.jsx(Ee,{children:e.jsxs(Z,{children:[e.jsx(h,{className:"text-xs font-semibold uppercase text-muted-foreground",children:"Demandeur"}),e.jsx(h,{className:"text-xs font-semibold uppercase text-muted-foreground",children:"Tag & Zone"}),e.jsx(h,{className:"text-xs font-semibold uppercase text-muted-foreground",children:"Motif & Durée"}),e.jsx(h,{className:"text-xs font-semibold uppercase text-muted-foreground",children:"Risque"}),e.jsx(h,{className:"text-xs font-semibold uppercase text-muted-foreground",children:"Validation requise"}),e.jsx(h,{className:"text-xs font-semibold uppercase text-muted-foreground text-right",children:"Actions"})]})}),e.jsx(qe,{children:oe.map(t=>{var s,r,n,d,j;return e.jsxs(Z,{className:"hover:bg-muted/50",children:[e.jsx(p,{children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-muted flex items-center justify-center shrink-0",children:e.jsx(je,{className:"w-4 h-4 text-muted-foreground"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:((s=t.requester)==null?void 0:s.full_name)||"N/A"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:ue(t.created_at)})]})]})}),e.jsx(p,{children:e.jsxs("div",{children:[e.jsx("span",{className:"font-mono font-semibold text-primary text-sm",children:((r=t.sensor)==null?void 0:r.code)||t.request_code}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[(d=(n=t.equipment)==null?void 0:n.zone)!=null&&d.name?`${t.equipment.zone.name} - `:"",((j=t.equipment)==null?void 0:j.name)||"N/A"]})]})}),e.jsx(p,{children:e.jsxs("div",{children:[e.jsx("p",{className:"text-sm",children:V(t.title)}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Durée: ",t.estimated_duration?`${t.estimated_duration} heures`:"N/A"]})]})}),e.jsx(p,{children:q(t.priority)}),e.jsx(p,{children:e.jsx(c,{variant:"outline",className:"text-xs font-medium",children:le(t)})}),e.jsx(p,{className:"text-right",children:e.jsx("div",{className:"flex items-center justify-end gap-2",children:M(t)!==null?e.jsxs(e.Fragment,{children:[e.jsx(u,{variant:"outline",size:"sm",className:"h-8 text-xs text-destructive border-destructive/30 hover:bg-destructive/10",onClick:()=>{g(t),N(!0)},children:"Refuser"}),e.jsx(u,{size:"sm",className:"h-8 text-xs",onClick:()=>E(t.id,{validation_status:"approved"},"",t),children:"Approuver"})]}):e.jsx("span",{className:"text-xs text-muted-foreground",children:"Non autorisé"})})})]},t.id)})})]})})})]}),R>1&&e.jsx("div",{className:"flex justify-end",children:e.jsx(ke,{children:e.jsxs(Te,{children:[e.jsx(S,{children:e.jsx(Me,{href:"#",onClick:t=>{t.preventDefault(),l>1&&b(l-1)},className:l===1?"pointer-events-none opacity-50":"cursor-pointer"})}),Array.from({length:R},(t,s)=>s+1).map(t=>e.jsx(S,{children:e.jsx(Pe,{href:"#",onClick:s=>{s.preventDefault(),b(t)},isActive:l===t,className:"cursor-pointer",children:t})},t)),e.jsx(S,{children:e.jsx(Ie,{href:"#",onClick:t=>{t.preventDefault(),l<R&&b(l+1)},className:l===R?"pointer-events-none opacity-50":"cursor-pointer"})})]})})}),a&&e.jsx(fe,{open:ee,onOpenChange:t=>{t||(N(!1),g(null))},children:e.jsxs(ve,{className:"max-w-lg",children:[e.jsxs(ge,{children:[e.jsxs(Ne,{children:["Rejeter la demande ",a.request_code]}),e.jsxs(be,{children:[(F=a.requester)==null?void 0:F.full_name," - ",($=a.equipment)==null?void 0:$.name]})]}),e.jsxs("div",{className:"space-y-4 mt-2",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground text-xs uppercase mb-1",children:"Capteur"}),e.jsx("p",{className:"font-mono font-semibold text-primary",children:((B=a.sensor)==null?void 0:B.code)||"N/A"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground text-xs uppercase mb-1",children:"Risque"}),q(a.priority)]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground text-xs uppercase mb-1",children:"Motif"}),e.jsx("p",{children:V(a.title)})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground text-xs uppercase mb-1",children:"Durée"}),e.jsx("p",{children:a.estimated_duration?`${a.estimated_duration}h`:"N/A"})]})]}),a.description&&e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground text-xs uppercase mb-1",children:"Description"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:a.description})]}),y(a.priority)&&e.jsxs("div",{className:"p-3 bg-muted/30 rounded-lg border text-sm",children:[e.jsx("p",{className:"font-medium mb-2",children:"Validation double requise"}),e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"Niveau 1: "}),e.jsx(c,{variant:"outline",className:"text-xs",children:a.validation_status_level1==="approved"?"Approuvé":"En attente"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"Niveau 2: "}),e.jsx(c,{variant:"outline",className:"text-xs",children:a.validation_status_level2==="approved"?"Approuvé":"En attente"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Re,{className:"text-xs font-medium uppercase text-muted-foreground",children:"Motif du rejet *"}),e.jsx(Ce,{className:"min-h-[100px]",placeholder:"Indiquez la raison du rejet...",value:I(a.id),onChange:t=>P(a.id,t.target.value)})]})]}),e.jsxs(_e,{className:"gap-2",children:[e.jsx(u,{variant:"outline",onClick:()=>{N(!1),g(null)},children:"Annuler"}),e.jsxs(u,{variant:"destructive",onClick:()=>{E(a.id,{validation_status:"rejected"},I(a.id),a),N(!1),g(null)},children:[e.jsx(G,{className:"w-4 h-4 mr-2"}),"Confirmer le rejet"]})]})]})})]})}export{We as default};
