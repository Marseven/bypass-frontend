import{G as pe,r as i,t as he,e as J,j as e,B as u,L as je,S as fe,U as ge,h as c,D as ve,x as Ne,y as be,z as ye,A as Ce,K as _e,J as m}from"./index-pCvRO2Br.js";import{C as G,a as K,b as we,c as Re}from"./card-kIjn88u6.js";import{T as De}from"./textarea-DRRxpjJ5.js";import{L as Se}from"./label-xi_Lpgn0.js";import{S as Ae,a as ke,b as Le,c as Te,d as f}from"./select-BrpyAvZD.js";import{P as Me,a as Pe,b as S,c as Ie,d as Ve,e as Be}from"./pagination-Bi8g-pqv.js";import{T as Ee,a as $e,b as X,c as p,d as qe,e as h}from"./table-CcrNq19Z.js";import{F as Z}from"./file-text-DzzSvCxI.js";import{T as ze}from"./triangle-alert-BnOns5Th.js";import{C as Fe,a as Q}from"./clock-DrAtUYTQ.js";import{C as W}from"./circle-x-DckgcAsH.js";import"./index-B0McoXqt.js";function st(){var q,z,F;const Y=pe(),[g,A]=i.useState([]),[ee,te]=i.useState({}),[a,v]=i.useState(null),[se,N]=i.useState(!1),[l,b]=i.useState(1),[y,He]=i.useState(10),[ae,D]=i.useState(!0),[k,L]=i.useState(null),[re,ie]=i.useState("all"),[C,ne]=i.useState("all"),{user:o}=he(),_=t=>t==="critical"||t==="emergency",T=()=>["chef_de_quart","responsable_hse","resp_exploitation","directeur","administrateur","supervisor","administrator","director"].includes((o==null?void 0:o.role)||""),le=()=>["resp_exploitation","directeur","administrateur","administrator","director"].includes((o==null?void 0:o.role)||""),M=t=>_(t.priority)?t.validation_status_level1==="pending"&&T()?1:t.validation_status_level1==="approved"&&t.validation_status_level2==="pending"&&le()?2:null:T()?1:null,P=(t,s)=>{te(r=>({...r,[t]:s}))},I=t=>ee[t]||"",oe={preventive_maintenance:"Maintenance préventive",corrective_maintenance:"Maintenance corrective",calibration:"Étalonnage",testing:"Tests",emergency_repair:"Réparation d'urgence",system_upgrade:"Mise à niveau système",investigation:"Investigation",other:"Autre"},V=t=>oe[t]??t,B=(t,s,r="",n)=>{try{const d=s.validation_status||"approved",j=r||s.rejection_reason||"";if(d==="rejected"&&j===""){m.error("Veuillez entrer un motif de rejet");return}if(n){const x=M(n);if(x===null){m.error("Vous n'êtes pas autorisé à valider cette demande");return}if(_(n.priority)&&x===2&&n.validation_status_level1!=="approved"){m.error("La validation niveau 1 doit être approuvée d'abord");return}}const H={...s};H.rejection_reason=d==="rejected"?j:null,J.put(`/requests/${t}/validate`,H).then(x=>{x.data&&(m.success(d==="approved"?"Demande approuvée":"Demande rejetée"),P(t,""),window.location.reload())}).catch(x=>{var O,U;m.error(((U=(O=x.response)==null?void 0:O.data)==null?void 0:U.message)||"Erreur lors de la validation")})}catch{m.error("Une erreur est survenue")}},E=t=>{switch(t==null?void 0:t.toLowerCase()){case"critical":return e.jsx(c,{className:"bg-red-600 text-white text-xs font-bold uppercase",children:"Critique"});case"high":return e.jsx(c,{className:"bg-orange-500 text-white text-xs font-bold uppercase",children:"Majeur"});case"medium":return e.jsx(c,{className:"bg-yellow-500 text-white text-xs font-bold uppercase",children:"Moyen"});case"low":case"normal":return e.jsx(c,{className:"bg-gray-400 text-white text-xs font-bold uppercase",children:"Mineur"});default:return e.jsx(c,{variant:"outline",className:"text-xs uppercase",children:t})}},ce=t=>_(t.priority)?t.validation_status_level1==="pending"?"Ingénieur Sécurité":t.validation_status_level1==="approved"&&t.validation_status_level2==="pending"?"Directeur":"Complète":"Chef de quart";i.useEffect(()=>{if(!o){D(!1);return}D(!0),L(null),J.get("/requests/pending").then(t=>{var r;const s=((r=t.data)==null?void 0:r.data)||(Array.isArray(t.data)?t.data:[]);A(s)}).catch(t=>{var s,r;L(((r=(s=t.response)==null?void 0:s.data)==null?void 0:r.message)||"Erreur de chargement"),A([])}).finally(()=>D(!1))},[Y.key,o]);const w=g.filter(t=>{var r;return C==="all"||((r=t.priority)==null?void 0:r.toLowerCase())===C}),R=Math.ceil(w.length/y),$=(l-1)*y,de=w.slice($,$+y);i.useEffect(()=>{b(1)},[y,C]);const ue=g.filter(t=>{var s;return((s=t.priority)==null?void 0:s.toLowerCase())==="critical"}).length,xe=[{title:"Demandes en attente",value:g.length,subtitle:`${g.length>0?"Nouvelles depuis 1h":"Aucune demande"}`,icon:Z,iconBg:"bg-primary/10",iconColor:"text-primary"},{title:"Risque Critique (SIL 3)",value:ue,subtitle:"Validation Ing. requise",icon:ze,iconBg:"bg-red-100",iconColor:"text-red-600"},{title:"Délai dépassé (> 2h)",value:0,subtitle:"En attente d'action rapide",icon:Fe,iconBg:"bg-orange-100",iconColor:"text-orange-600"},{title:"Approuvés aujourd'hui",value:"-",subtitle:"Sur les demandes traitées",icon:Q,iconBg:"bg-primary/10",iconColor:"text-primary"}],me=t=>{const s=Date.now()-new Date(t).getTime(),r=Math.floor(s/6e4);if(r<60)return`Il y a ${r} min`;const n=Math.floor(r/60);return n<24?`Il y a ${n}h`:`Il y a ${Math.floor(n/24)}j`};return e.jsxs("div",{className:"w-full p-4 md:p-6 space-y-6 overflow-x-hidden",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-foreground",children:"Approbations"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Aperçu et gestion des demandes d'inhibition de capteurs en attente."})]}),e.jsx(u,{asChild:!0,className:"w-full sm:w-auto",children:e.jsxs(je,{to:"/requests/new",className:"flex items-center justify-center gap-2",children:[e.jsx(Z,{className:"w-4 h-4"}),"Nouveau Bypass"]})})]}),e.jsx("div",{className:"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4",children:xe.map(t=>e.jsx(G,{className:"hover:shadow-md transition-shadow",children:e.jsx(K,{className:"p-5",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:t.title}),e.jsx("p",{className:"text-3xl font-bold tracking-tight",children:t.value}),e.jsx("p",{className:"text-xs text-muted-foreground",children:t.subtitle})]}),e.jsx("div",{className:`p-2 rounded-lg ${t.iconBg}`,children:e.jsx(t.icon,{className:`w-5 h-5 ${t.iconColor}`})})]})})},t.title))}),e.jsxs(G,{children:[e.jsx(we,{className:"pb-3",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs(Re,{className:"text-lg",children:["Liste des demandes (",w.length,")"]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx(u,{variant:re==="all"?"default":"outline",size:"sm",className:"h-8 text-xs",onClick:()=>ie("all"),children:"Statut: En attente"}),e.jsxs(Ae,{value:C,onValueChange:ne,children:[e.jsx(ke,{className:"w-[140px] h-8 text-xs",children:e.jsx(Le,{placeholder:"Risque: Tous"})}),e.jsxs(Te,{children:[e.jsx(f,{value:"all",children:"Risque: Tous"}),e.jsx(f,{value:"critical",children:"Critique"}),e.jsx(f,{value:"high",children:"Majeur"}),e.jsx(f,{value:"medium",children:"Moyen"}),e.jsx(f,{value:"low",children:"Mineur"})]})]})]})]})}),e.jsx(K,{children:ae?e.jsx("div",{className:"space-y-3",children:[...Array(3)].map((t,s)=>e.jsx(fe,{className:"h-16 w-full"},s))}):k?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(W,{className:"w-10 h-10 text-destructive mx-auto mb-3"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-3",children:k}),e.jsx(u,{size:"sm",onClick:()=>window.location.reload(),children:"Réessayer"})]}):w.length===0?e.jsxs("div",{className:"text-center py-12 text-muted-foreground",children:[e.jsx(Q,{className:"w-10 h-10 mx-auto mb-3 opacity-50"}),e.jsx("p",{children:"Aucune demande en attente"})]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(Ee,{children:[e.jsx($e,{children:e.jsxs(X,{children:[e.jsx(p,{className:"text-xs font-semibold uppercase text-muted-foreground",children:"Demandeur"}),e.jsx(p,{className:"text-xs font-semibold uppercase text-muted-foreground",children:"Tag & Zone"}),e.jsx(p,{className:"text-xs font-semibold uppercase text-muted-foreground",children:"Motif & Durée"}),e.jsx(p,{className:"text-xs font-semibold uppercase text-muted-foreground",children:"Risque"}),e.jsx(p,{className:"text-xs font-semibold uppercase text-muted-foreground",children:"Validation requise"}),e.jsx(p,{className:"text-xs font-semibold uppercase text-muted-foreground text-right",children:"Actions"})]})}),e.jsx(qe,{children:de.map(t=>{var s,r,n,d,j;return e.jsxs(X,{className:"hover:bg-muted/50",children:[e.jsx(h,{children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-muted flex items-center justify-center shrink-0",children:e.jsx(ge,{className:"w-4 h-4 text-muted-foreground"})}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:((s=t.requester)==null?void 0:s.full_name)||"N/A"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:me(t.created_at)})]})]})}),e.jsx(h,{children:e.jsxs("div",{children:[e.jsx("span",{className:"font-mono font-semibold text-primary text-sm",children:((r=t.sensor)==null?void 0:r.code)||t.request_code}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[(d=(n=t.equipment)==null?void 0:n.zone)!=null&&d.name?`${t.equipment.zone.name} - `:"",((j=t.equipment)==null?void 0:j.name)||"N/A"]})]})}),e.jsx(h,{children:e.jsxs("div",{children:[e.jsx("p",{className:"text-sm",children:V(t.title)}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Durée: ",t.estimated_duration?`${t.estimated_duration} heures`:"N/A"]})]})}),e.jsx(h,{children:E(t.priority)}),e.jsx(h,{children:e.jsx(c,{variant:"outline",className:"text-xs font-medium",children:ce(t)})}),e.jsx(h,{className:"text-right",children:e.jsx("div",{className:"flex items-center justify-end gap-2",children:M(t)!==null?e.jsxs(e.Fragment,{children:[e.jsx(u,{variant:"outline",size:"sm",className:"h-8 text-xs text-destructive border-destructive/30 hover:bg-destructive/10",onClick:()=>{v(t),N(!0)},children:"Refuser"}),e.jsx(u,{size:"sm",className:"h-8 text-xs",onClick:()=>B(t.id,{validation_status:"approved"},"",t),children:"Approuver"})]}):e.jsx("span",{className:"text-xs text-muted-foreground",children:"Non autorisé"})})})]},t.id)})})]})})})]}),R>1&&e.jsx("div",{className:"flex justify-end",children:e.jsx(Me,{children:e.jsxs(Pe,{children:[e.jsx(S,{children:e.jsx(Ie,{href:"#",onClick:t=>{t.preventDefault(),l>1&&b(l-1)},className:l===1?"pointer-events-none opacity-50":"cursor-pointer"})}),Array.from({length:R},(t,s)=>s+1).map(t=>e.jsx(S,{children:e.jsx(Ve,{href:"#",onClick:s=>{s.preventDefault(),b(t)},isActive:l===t,className:"cursor-pointer",children:t})},t)),e.jsx(S,{children:e.jsx(Be,{href:"#",onClick:t=>{t.preventDefault(),l<R&&b(l+1)},className:l===R?"pointer-events-none opacity-50":"cursor-pointer"})})]})})}),a&&e.jsx(ve,{open:se,onOpenChange:t=>{t||(N(!1),v(null))},children:e.jsxs(Ne,{className:"max-w-lg",children:[e.jsxs(be,{children:[e.jsxs(ye,{children:["Rejeter la demande ",a.request_code]}),e.jsxs(Ce,{children:[(q=a.requester)==null?void 0:q.full_name," - ",(z=a.equipment)==null?void 0:z.name]})]}),e.jsxs("div",{className:"space-y-4 mt-2",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4 text-sm",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground text-xs uppercase mb-1",children:"Capteur"}),e.jsx("p",{className:"font-mono font-semibold text-primary",children:((F=a.sensor)==null?void 0:F.code)||"N/A"})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground text-xs uppercase mb-1",children:"Risque"}),E(a.priority)]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground text-xs uppercase mb-1",children:"Motif"}),e.jsx("p",{children:V(a.title)})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground text-xs uppercase mb-1",children:"Durée"}),e.jsx("p",{children:a.estimated_duration?`${a.estimated_duration}h`:"N/A"})]})]}),a.description&&e.jsxs("div",{children:[e.jsx("p",{className:"text-muted-foreground text-xs uppercase mb-1",children:"Description"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:a.description})]}),_(a.priority)&&e.jsxs("div",{className:"p-3 bg-muted/30 rounded-lg border text-sm",children:[e.jsx("p",{className:"font-medium mb-2",children:"Validation double requise"}),e.jsxs("div",{className:"flex gap-4",children:[e.jsxs("div",{children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"Niveau 1: "}),e.jsx(c,{variant:"outline",className:"text-xs",children:a.validation_status_level1==="approved"?"Approuvé":"En attente"})]}),e.jsxs("div",{children:[e.jsx("span",{className:"text-xs text-muted-foreground",children:"Niveau 2: "}),e.jsx(c,{variant:"outline",className:"text-xs",children:a.validation_status_level2==="approved"?"Approuvé":"En attente"})]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Se,{className:"text-xs font-medium uppercase text-muted-foreground",children:"Motif du rejet *"}),e.jsx(De,{className:"min-h-[100px]",placeholder:"Indiquez la raison du rejet...",value:I(a.id),onChange:t=>P(a.id,t.target.value)})]})]}),e.jsxs(_e,{className:"gap-2",children:[e.jsx(u,{variant:"outline",onClick:()=>{N(!1),v(null)},children:"Annuler"}),e.jsxs(u,{variant:"destructive",onClick:()=>{B(a.id,{validation_status:"rejected"},I(a.id),a),N(!1),v(null)},children:[e.jsx(W,{className:"w-4 h-4 mr-2"}),"Confirmer le rejet"]})]})]})})]})}export{st as default};
