import{t as ge,r as n,j as e,B as d,y as fe,s as p,S as ve,ae as Ne,h as v,E as Se,D as ye,F as Ce,G as be,H as we,K as Te,N as Ae,w as De,e as A,J as x}from"./index-DddjZrTs.js";import{C as K,a as Y}from"./card-HJdulpyU.js";import{L as u}from"./label-BzSdYhZy.js";import{S as V,a as L,b as k,c as M,d as o}from"./select-DBKdREnk.js";import{T as Ee,a as Ie,b as Q,c as N,d as Pe,e as S}from"./table-DT_PqPTr.js";import{A as qe,a as Ve,T as Le,b as ke,c as Me,d as ze,e as $e,f as Be,g as Oe,h as _e}from"./alert-dialog-CYkNhPS5.js";import{P as Ue,a as Fe,b as B,c as He,d as Re,e as Je}from"./pagination-BKLQRlEH.js";import{e as Ze}from"./exportData-BegFHT0r.js";import{U as Ge,C as Ke}from"./CsvImportDialog-Ds70GtVy.js";import{D as Ye}from"./download-EIZQr-HN.js";import{P as Qe}from"./plus-ClRgL7g0.js";import{P as We}from"./pencil-VxOT-H-2.js";import"./index-B6Fl2CXf.js";import"./file-text-BLpMISKA.js";const ps=()=>{const O=ge(),[W,_]=n.useState([]),[y,X]=n.useState(""),[D,ee]=n.useState("all"),[E,se]=n.useState("all"),[z,Xe]=n.useState("all"),[te,U]=n.useState(!1),[ae,$]=n.useState(!1),[m,ne]=n.useState(null),[a,c]=n.useState({name:"",code:"",type:"temperature",unit:"",minValue:0,maxValue:100,criticalThreshold:80,equipmentId:"",status:"active"}),[j,F]=n.useState([]),[l,C]=n.useState(1),[I]=n.useState(15),[H,R]=n.useState(!0),[J,P]=n.useState(!1),re=async()=>{var s;try{const i=((s=(await A.get("/equipment")).data)==null?void 0:s.data)||[];_(i.map(t=>{var h;return{id:t.id,name:t.name,code:t.code,type:t.type,zone:((h=t.zone)==null?void 0:h.name)||"N/A",fabricant:t.fabricant,status:t.status,criticite:t.criticite,sensors:t.sensors}}))}catch{_([])}},b=async()=>{var s;R(!0);try{const i=((s=(await A.get("/sensors")).data)==null?void 0:s.data)||[];F(i.map(t=>{var h,T,Z,G;return{id:t.id,equipmentId:t.equipment_id,name:t.name,code:t.code,type:t.type,unit:t.unite,criticalThreshold:t.seuil_critique,status:t.status,lastCalibration:t.Dernier_Etallonnage?new Date(t.Dernier_Etallonnage.replace(" ","T")).toLocaleString():"N/A",equipmentName:`${((h=t.equipment)==null?void 0:h.name)||"N/A"} - ${((Z=(T=t.equipment)==null?void 0:T.zone)==null?void 0:Z.name)||"N/A"}`,equipmentCode:(G=t.equipment)==null?void 0:G.code,isActive:t.status==="active"}}))}catch{F([])}R(!1)};n.useEffect(()=>{re(),b()},[]);const g=j.filter(s=>{var T;const r=s.name.toLowerCase().includes(y.toLowerCase())||s.code.toLowerCase().includes(y.toLowerCase())||(((T=s.equipmentName)==null?void 0:T.toLowerCase())||"").includes(y.toLowerCase()),i=D==="all"||s.type===D,t=E==="all"||s.status===E,h=z==="all"||String(s.equipmentId)===z;return r&&i&&t&&h}),f=Math.ceil(g.length/I),ie=g.slice((l-1)*I,l*I);n.useEffect(()=>{C(1)},[y,D,E,z]),n.useEffect(()=>{const s=Math.ceil(g.length/I);s>0&&l>s&&C(s)},[g.length]);const le=async()=>{P(!0);try{await A.post(`/equipment/${a.equipmentId}/sensors`,{...a,criticalThreshold:String(a.criticalThreshold||"")}),x.success("Capteur créé"),b(),w()}catch{x.error("Erreur lors de l'ajout")}P(!1)},ce=async()=>{if(m){P(!0);try{await A.put(`/sensors/${m.id}`,{...a,criticalThreshold:String(a.criticalThreshold||"")}),x.success("Capteur modifié"),b(),w()}catch{x.error("Erreur lors de la modification")}P(!1)}},oe=async s=>{var r,i;try{await A.delete(`/sensors/${s}`),x.success("Capteur supprimé"),b()}catch(t){x.error(((i=(r=t.response)==null?void 0:r.data)==null?void 0:i.message)||"Erreur lors de la suppression")}},w=()=>{c({name:"",code:"",type:"temperature",unit:"",minValue:0,maxValue:100,criticalThreshold:80,equipmentId:"",status:"active"}),ne(null),U(!1)},de=()=>{Ze(g.map(s=>({Code:s.code,Nom:s.name,Type:q(s.type),Unité:s.unit||"N/A","Seuil critique":s.criticalThreshold||"N/A",Statut:ue(s.status),Équipement:s.equipmentName||"N/A"})),`capteurs_${new Date().toISOString().split("T")[0]}`),x.success("Export réussi")},q=s=>({temperature:"Température",pressure:"Pression",vibration:"Vibration",flow:"Débit",level:"Niveau",speed:"Vitesse",position:"Position",other:"Autre"})[s]||s,ue=s=>({active:"Sain",bypassed:"En bypass",maintenance:"En maintenance",inactive:"Inactif",faulty:"En défaut"})[s]||s,me=s=>{switch(s){case"active":return e.jsx(v,{className:"bg-primary text-primary-foreground text-xs font-bold",children:"SAIN"});case"bypassed":return e.jsx(v,{className:"bg-red-600 text-white text-xs font-bold",children:"EN BYPASS"});case"maintenance":return e.jsx(v,{variant:"outline",className:"text-xs font-bold",children:"EN MAINTENANCE"});case"inactive":case"faulty":return e.jsx(v,{className:"bg-orange-500 text-white text-xs font-bold",children:"EN DÉFAUT"});default:return e.jsx(v,{variant:"outline",className:"text-xs",children:s})}},he=j.filter(s=>s.status==="active").length,pe=j.filter(s=>s.status==="bypassed").length,xe=j.filter(s=>["inactive","faulty","maintenance"].includes(s.status)).length,je=[{label:"Total Capteurs",value:j.length},{label:"Sains / Actifs",value:he},{label:"En Bypass",value:pe},{label:"En Défaut / Déconnectés",value:xe}];return e.jsxs("div",{className:"w-full p-4 md:p-6 space-y-6 overflow-x-hidden",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-foreground",children:"Inventaire des Capteurs"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Registre complet et statut en temps réel des ",j.length," instruments de mesure du site."]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(d,{variant:"outline",size:"sm",onClick:de,children:[e.jsx(Ye,{className:"w-4 h-4 mr-2"}),"Exporter CSV"]}),e.jsxs(d,{variant:"outline",size:"sm",onClick:()=>$(!0),children:[e.jsx(Ge,{className:"w-4 h-4 mr-2"}),"Importer"]}),e.jsxs(d,{size:"sm",onClick:()=>{w(),U(!0)},children:[e.jsx(Qe,{className:"w-4 h-4 mr-2"}),"Ajouter un Capteur"]})]})]}),e.jsx("div",{className:"grid grid-cols-2 lg:grid-cols-4 gap-4",children:je.map(s=>e.jsx(K,{className:"hover:shadow-md transition-shadow",children:e.jsx(Y,{className:"p-5",children:e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:s.label}),e.jsx("p",{className:"text-3xl font-bold tracking-tight",children:H?"...":s.value.toLocaleString()})]})})},s.label))}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3",children:[e.jsxs("div",{className:"relative flex-1 min-w-[200px] max-w-md",children:[e.jsx(fe,{className:"absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-muted-foreground"}),e.jsx(p,{placeholder:"Chercher par Tag, Zone, Modèle...",className:"pl-10 h-9",value:y,onChange:s=>X(s.target.value)})]}),e.jsxs(V,{value:D,onValueChange:ee,children:[e.jsx(L,{className:"w-[130px] h-9 text-sm",children:e.jsx(k,{placeholder:"Type: Tous"})}),e.jsxs(M,{children:[e.jsx(o,{value:"all",children:"Type: Tous"}),["temperature","pressure","vibration","flow","level","speed","position"].map(s=>e.jsx(o,{value:s,children:q(s)},s))]})]}),e.jsxs(V,{value:E,onValueChange:se,children:[e.jsx(L,{className:"w-[130px] h-9 text-sm",children:e.jsx(k,{placeholder:"Statut: Tous"})}),e.jsxs(M,{children:[e.jsx(o,{value:"all",children:"Statut: Tous"}),e.jsx(o,{value:"active",children:"Sain"}),e.jsx(o,{value:"bypassed",children:"En Bypass"}),e.jsx(o,{value:"maintenance",children:"Maintenance"}),e.jsx(o,{value:"inactive",children:"Inactif"})]})]})]}),e.jsx(K,{children:e.jsx(Y,{className:"p-0",children:H?e.jsx("div",{className:"p-6 space-y-3",children:[...Array(5)].map((s,r)=>e.jsx(ve,{className:"h-14 w-full"},r))}):g.length===0?e.jsxs("div",{className:"text-center py-12 text-muted-foreground",children:[e.jsx(Ne,{className:"w-10 h-10 mx-auto mb-3 opacity-50"}),e.jsx("p",{children:"Aucun capteur trouvé"})]}):e.jsx("div",{className:"overflow-x-auto",children:e.jsxs(Ee,{children:[e.jsx(Ie,{children:e.jsxs(Q,{children:[e.jsx(N,{className:"text-xs font-semibold uppercase text-muted-foreground",children:"Identifiant & Description"}),e.jsx(N,{className:"text-xs font-semibold uppercase text-muted-foreground",children:"Type"}),e.jsx(N,{className:"text-xs font-semibold uppercase text-muted-foreground",children:"Zone"}),e.jsx(N,{className:"text-xs font-semibold uppercase text-muted-foreground",children:"Seuil"}),e.jsx(N,{className:"text-xs font-semibold uppercase text-muted-foreground",children:"Statut actuel"}),e.jsx(N,{className:"text-xs font-semibold uppercase text-muted-foreground text-right",children:"Actions"})]})}),e.jsx(Pe,{children:ie.map(s=>e.jsxs(Q,{className:"hover:bg-muted/50",children:[e.jsx(S,{children:e.jsxs("div",{children:[e.jsx("span",{className:"font-mono font-semibold text-primary text-sm",children:s.code}),e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5",children:s.name})]})}),e.jsx(S,{className:"text-sm",children:q(s.type)}),e.jsx(S,{className:"text-sm text-muted-foreground",children:s.equipmentName||"N/A"}),e.jsx(S,{children:s.criticalThreshold?e.jsxs(v,{variant:"outline",className:"text-xs",children:[s.criticalThreshold," ",s.unit]}):"-"}),e.jsx(S,{children:me(s.status)}),e.jsx(S,{className:"text-right",children:e.jsxs("div",{className:"flex items-center justify-end gap-1",children:[e.jsx(d,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:()=>O(`/sensors/${s.id}`),children:e.jsx(Se,{className:"w-3.5 h-3.5"})}),e.jsx(d,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:()=>O(`/sensors/${s.id}/edit`),children:e.jsx(We,{className:"w-3.5 h-3.5"})}),e.jsxs(qe,{children:[e.jsx(Ve,{asChild:!0,children:e.jsx(d,{variant:"ghost",size:"icon",className:"h-8 w-8 text-destructive hover:text-destructive",children:e.jsx(Le,{className:"w-3.5 h-3.5"})})}),e.jsxs(ke,{children:[e.jsxs(Me,{children:[e.jsxs(ze,{children:["Supprimer ",s.code," ?"]}),e.jsx($e,{children:"Cette action est irréversible."})]}),e.jsxs(Be,{children:[e.jsx(Oe,{children:"Annuler"}),e.jsx(_e,{onClick:()=>oe(s.id),children:"Supprimer"})]})]})]})]})})]},s.id))})]})})})}),f>1&&e.jsx("div",{className:"flex justify-end",children:e.jsx(Ue,{children:e.jsxs(Fe,{children:[e.jsx(B,{children:e.jsx(He,{href:"#",onClick:s=>{s.preventDefault(),l>1&&C(l-1)},className:l===1?"pointer-events-none opacity-50":"cursor-pointer"})}),Array.from({length:Math.min(f,5)},(s,r)=>{const i=f<=5?r+1:Math.max(1,Math.min(l-2,f-4))+r;return e.jsx(B,{children:e.jsx(Re,{href:"#",onClick:t=>{t.preventDefault(),C(i)},isActive:l===i,className:"cursor-pointer",children:i})},i)}),e.jsx(B,{children:e.jsx(Je,{href:"#",onClick:s=>{s.preventDefault(),l<f&&C(l+1)},className:l===f?"pointer-events-none opacity-50":"cursor-pointer"})})]})})}),e.jsx(ye,{open:te,onOpenChange:s=>{s||w()},children:e.jsxs(Ce,{className:"max-w-lg",children:[e.jsxs(be,{children:[e.jsx(we,{children:m?`Éditer ${m.code}`:"Ajouter un capteur"}),e.jsx(Te,{children:m?"Modifier les informations du capteur":"Remplir les informations du nouveau capteur"})]}),e.jsxs("div",{className:"grid gap-4 py-2",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Nom *"}),e.jsx(p,{value:a.name,onChange:s=>c({...a,name:s.target.value}),placeholder:"Nom du capteur"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Code *"}),e.jsx(p,{value:a.code,onChange:s=>c({...a,code:s.target.value}),placeholder:"PT-3042"})]})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Type"}),e.jsxs(V,{value:a.type,onValueChange:s=>c({...a,type:s}),children:[e.jsx(L,{children:e.jsx(k,{})}),e.jsx(M,{children:["temperature","pressure","vibration","flow","level","speed","position"].map(s=>e.jsx(o,{value:s,children:q(s)},s))})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Unité"}),e.jsx(p,{value:a.unit,onChange:s=>c({...a,unit:s.target.value}),placeholder:"°C, bar, mm/s..."})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Min"}),e.jsx(p,{type:"number",value:a.minValue,onChange:s=>c({...a,minValue:Number(s.target.value)})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Max"}),e.jsx(p,{type:"number",value:a.maxValue,onChange:s=>c({...a,maxValue:Number(s.target.value)})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Seuil critique"}),e.jsx(p,{type:"number",value:a.criticalThreshold,onChange:s=>c({...a,criticalThreshold:Number(s.target.value)})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(u,{children:"Équipement *"}),e.jsxs(V,{value:a.equipmentId,onValueChange:s=>c({...a,equipmentId:s}),children:[e.jsx(L,{children:e.jsx(k,{placeholder:"Sélectionner un équipement"})}),e.jsx(M,{children:W.map(s=>e.jsxs(o,{value:String(s.id),children:[s.name," (",s.code,")"]},s.id))})]})]})]}),e.jsxs(Ae,{className:"gap-2",children:[e.jsx(d,{variant:"outline",onClick:w,children:"Annuler"}),e.jsxs(d,{onClick:m?ce:le,disabled:J,children:[J&&e.jsx(De,{className:"w-4 h-4 mr-2 animate-spin"}),m?"Enregistrer":"Ajouter"]})]})]})}),e.jsx(Ke,{open:ae,onOpenChange:$,type:"sensors",onSuccess:()=>{b(),$(!1)}})]})};export{ps as default};
